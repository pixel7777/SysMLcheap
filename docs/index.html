<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SysMLcheap â€” Model Tables</title>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4/dist/js-yaml.min.js"></script>
  <style>
    :root {
      --bg: #ffffff; --surface: #ffffff; --border: #d0d7de;
      --text: #1f2328; --muted: #555555; --accent: #0969da;
      --green: #1a7f37; --yellow: #9a6700; --red: #cf222e;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
           background: var(--bg); color: var(--text); padding: 2rem; line-height: 1.5; }
    h1 { font-size: 1.5rem; margin-bottom: 0.25rem; }
    .subtitle { color: var(--muted); margin-bottom: 1.5rem; font-size: 0.9rem; }
    nav { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
    nav button { background: var(--surface); color: var(--text); border: 1px solid var(--border);
                 padding: 0.4rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; }
    nav button:hover { border-color: var(--accent); }
    nav button.active { background: var(--accent); color: #fff; border-color: var(--accent); }
    .status { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 12px;
              font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
    .status-mvp { background: #dafbe1; color: var(--green); }
    .status-future { background: #fff8c5; color: var(--yellow); }
    .status-commercial { background: #eae6ff; color: #6f42c1; }
    .status-implemented { background: #ddf4ff; color: #0969da; }
    .status-deprecated { background: #ffebe9; color: var(--red); }
    table { width: 100%; border-collapse: collapse; background: var(--surface);
            border-radius: 8px; overflow: hidden; table-layout: fixed; }
    thead { background: #f6f8fa; }
    th { text-align: left; padding: 0.6rem 1.2rem 0.6rem 1rem; font-size: 0.8rem; text-transform: uppercase;
         color: var(--muted); border-bottom: 1px solid var(--border); white-space: nowrap;
         cursor: pointer; user-select: none; position: relative; }
    th.dragging { opacity: 0.5; }
    .header-label { display: inline-block; max-width: calc(100% - 12px); overflow: hidden; text-overflow: ellipsis; }
    .resize-handle { position: absolute; top: 0; right: 0; width: 8px; height: 100%; cursor: col-resize; }
    .resize-handle:hover { background: rgba(9,105,218,0.15); }
    th:hover { color: var(--accent); }
    th .sort-arrow { font-size: 0.7rem; margin-left: 0.3rem; }
    th .col-filter { display: block; margin-top: 0.3rem; }
    th .col-filter input, th .col-filter select {
      width: 100%; font-size: 0.75rem; padding: 0.2rem 0.4rem;
      border: 1px solid var(--border); border-radius: 3px;
      background: #fff; color: var(--text); font-weight: normal; text-transform: none; }
    td { padding: 0.6rem 1rem; border-bottom: 1px solid var(--border);
         font-size: 0.85rem; vertical-align: top; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #f6f8fa; }
    td.doc { max-width: 420px; color: var(--muted); }
    td.id { font-family: 'SFMono-Regular', Consolas, monospace; font-size: 0.8rem; color: var(--muted); }
    .toolbar { display: flex; gap: 0.75rem; margin-bottom: 1rem; align-items: center; flex-wrap: wrap; }
    .toolbar label { font-size: 0.8rem; color: var(--muted); }
    .toolbar input {
      background: var(--surface); color: var(--text); border: 1px solid var(--border);
      padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.85rem; }
    .toolbar button { background: var(--surface); color: var(--muted); border: 1px solid var(--border);
      padding: 0.3rem 0.7rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer; }
    .toolbar button:hover { border-color: var(--accent); color: var(--accent); }
    #loading { color: var(--muted); padding: 2rem; text-align: center; }
    #error { color: var(--red); padding: 2rem; text-align: center; display: none; }
    .count { color: var(--muted); font-size: 0.8rem; margin-bottom: 0.5rem; }
  </style>
</head>
<body>
  <h1>ğŸ§™â€â™‚ï¸ SysMLcheap â€” Model Tables</h1>
  <p class="subtitle">Live from YAML Â· auto-updates on every page load</p>

  <nav id="tabs"></nav>

  <div class="toolbar">
    <label>Search: </label>
    <input id="search" type="text" placeholder="filter across all columnsâ€¦" />
    <button id="clearAll" title="Clear all filters and sorting">âœ• Clear filters</button>
    <button id="resetLayout" title="Reset column order and widths">â†º Reset layout</button>
    <a href="./diagrams.html" style="text-decoration:none;border:1px solid var(--border);padding:0.3rem 0.7rem;border-radius:4px;font-size:0.8rem;color:var(--muted);">Open live diagrams</a>
  </div>

  <div class="count" id="count"></div>
  <div id="loading">Loading model dataâ€¦</div>
  <div id="error"></div>
  <div id="tableWrap"></div>

  <script>
    // â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const REPO_OWNER = 'pixel7777';
    const REPO_NAME  = 'SysMLcheap';
    const BRANCH     = 'main';
    const BASE_RAW   = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${BRANCH}`;

    // filterable: 'text' (free input) | 'select' (dropdown of unique values) | false
    const TABLES = [
      {
        id: 'actors',
        label: 'Actors',
        file: 'model/behavioral.yaml',
        key: 'actors',
        columns: [
          { header: 'Name',       field: 'name',           filterable: 'text',   sortable: true },
          { header: 'ID',         field: 'id',       cls: 'id', filterable: 'text', sortable: true },
          { header: 'Status',     field: 'status',         filterable: 'select', sortable: true, render: statusBadge },
          { header: 'Owner',      field: 'ownerRef', cls: 'id', filterable: 'select', sortable: true },
          { header: 'Use Cases',  field: 'useCaseRefs',    filterable: false,    sortable: false, render: refList },
          { header: 'Realized By',field: 'realizedByRefs', filterable: false,    sortable: false, render: refList },
          { header: 'Documentation', field: 'documentation', cls: 'doc', filterable: 'text', sortable: true },
        ]
      },
      {
        id: 'usecases',
        label: 'Use Cases',
        file: 'model/behavioral.yaml',
        key: 'useCases',
        columns: [
          { header: 'Name',       field: 'name',              filterable: 'text',   sortable: true },
          { header: 'ID',         field: 'id',       cls: 'id', filterable: 'text', sortable: true },
          { header: 'Status',     field: 'status',         filterable: 'select', sortable: true, render: statusBadge },
          { header: 'Owner',      field: 'ownerRef', cls: 'id', filterable: 'select', sortable: true },
          { header: 'Actors',     field: 'actorRefs',           filterable: false,    sortable: false, render: refList },
          { header: 'Extends',    field: 'extendRefs',          filterable: false,    sortable: false, render: refList },
          { header: 'Includes',   field: 'includeRefs',         filterable: false,    sortable: false, render: refList },
          { header: 'Traces To',  field: 'traceRefs',           filterable: false,    sortable: false, render: refList },
          { header: 'Documentation', field: 'documentation', cls: 'doc', filterable: 'text', sortable: true },
        ]
      },
      {
        id: 'logical-blocks',
        label: 'Logical Blocks',
        file: 'model/logical.yaml',
        key: 'blocks',
        rowFilter: (row) => ['logical', 'context', 'external'].includes((row.stereotype || '').toLowerCase()),
        columns: [
          { header: 'Name',          field: 'name',          filterable: 'text',   sortable: true },
          { header: 'ID',            field: 'id', cls: 'id', filterable: 'text',   sortable: true },
          { header: 'Stereotype',    field: 'stereotype',    filterable: 'select', sortable: true },
          { header: 'Status',        field: 'status',        filterable: 'select', sortable: true, render: statusBadge },
          { header: 'Owner',         field: 'ownerRef', cls: 'id', filterable: 'select', sortable: true },
          { header: 'Realizes Actors', field: '_realizedActors', filterable: false, sortable: false, render: (_, row) => refList(getRealizedActors(row)) },
          { header: 'Realizes Use Cases', field: '_realizedUseCases', filterable: false, sortable: false, render: (_, row) => refList(getRealizedUseCases(row)) },
          { header: 'Part Types',    field: '_partTypeRefs', filterable: false, sortable: false, render: (_, row) => refList((row.parts || []).map(p => p.typeRef).filter(Boolean)) },
          { header: 'Port Interfaces', field: '_portTypeRefs', filterable: false, sortable: false, render: (_, row) => refList((row.ports || []).map(p => p.typeRef).filter(Boolean)) },
          { header: 'Documentation', field: 'documentation', cls: 'doc', filterable: 'text', sortable: true },
        ]
      }
    ];

    // â”€â”€ Renderers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function statusBadge(val) {
      const v = (val || 'unknown').toLowerCase();
      return `<span class="status status-${v}">${v}</span>`;
    }
    let currentRefMap = {};

    function refList(val) {
      if (!val || !Array.isArray(val) || val.length === 0) return '<span style="color:var(--muted)">â€”</span>';
      return val.map(r => {
        const target = currentRefMap[r];
        return target
          ? `<code title="${target.name}">${target.name}</code>`
          : `<code>${r}</code>`;
      }).join(', ');
    }
    function sortValue(val) {
      if (val == null) return '';
      if (Array.isArray(val)) return val.length.toString();
      return String(val).toLowerCase();
    }
    function getRealizedActors(row) {
      const direct = Array.isArray(row.realizationRefs) ? row.realizationRefs : [];
      const viaParts = Array.isArray(row.parts)
        ? row.parts.flatMap(p => Array.isArray(p.realizationRefs) ? p.realizationRefs : [])
        : [];
      return [...new Set([...direct, ...viaParts].filter(r => String(r).startsWith('act_')))];
    }
    function getRealizedUseCases(row) {
      const direct = Array.isArray(row.realizationRefs) ? row.realizationRefs : [];
      const viaParts = Array.isArray(row.parts)
        ? row.parts.flatMap(p => Array.isArray(p.realizationRefs) ? p.realizationRefs : [])
        : [];
      return [...new Set([...direct, ...viaParts].filter(r => String(r).startsWith('uc_')))];
    }

    // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let currentTable = TABLES[0].id;
    let yamlCache = {};
    let sortCol = null;   // field name
    let sortAsc = true;
    let colFilters = {};  // field -> value
    let tablePrefs = loadTablePrefs(); // tableId -> { order: [field], widths: {field:px} }

    // â”€â”€ Build tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const tabsEl = document.getElementById('tabs');
    TABLES.forEach(t => {
      const btn = document.createElement('button');
      btn.textContent = t.label;
      btn.dataset.id = t.id;
      btn.onclick = () => { currentTable = t.id; resetFilters(); renderAll(); };
      tabsEl.appendChild(btn);
    });

    function resetFilters() {
      sortCol = null; sortAsc = true; colFilters = {};
      document.getElementById('search').value = '';
    }

    function loadTablePrefs() {
      try { return JSON.parse(localStorage.getItem('sysmlcheap.tablePrefs') || '{}'); }
      catch { return {}; }
    }
    function saveTablePrefs() {
      localStorage.setItem('sysmlcheap.tablePrefs', JSON.stringify(tablePrefs));
    }
    function getCurrentPrefs(tableDef) {
      if (!tablePrefs[tableDef.id]) tablePrefs[tableDef.id] = { order: [], widths: {} };
      if (!Array.isArray(tablePrefs[tableDef.id].order)) tablePrefs[tableDef.id].order = [];
      if (!tablePrefs[tableDef.id].widths || typeof tablePrefs[tableDef.id].widths !== 'object') tablePrefs[tableDef.id].widths = {};
      return tablePrefs[tableDef.id];
    }
    function getOrderedColumns(tableDef) {
      const prefs = getCurrentPrefs(tableDef);
      const byField = Object.fromEntries(tableDef.columns.map(c => [c.field, c]));
      const ordered = prefs.order.map(f => byField[f]).filter(Boolean);
      const missing = tableDef.columns.filter(c => !prefs.order.includes(c.field));
      return [...ordered, ...missing];
    }

    // â”€â”€ Fetch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function fetchYaml(file) {
      if (yamlCache[file]) return yamlCache[file];
      const url = `${BASE_RAW}/${file}`;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`Failed to fetch ${file}: ${resp.status}`);
      const text = await resp.text();
      const data = jsyaml.load(text);
      yamlCache[file] = data;
      return data;
    }

    // â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderAll() {
      tabsEl.querySelectorAll('button').forEach(b =>
        b.classList.toggle('active', b.dataset.id === currentTable));
      loadTable(TABLES.find(t => t.id === currentTable));
    }

    async function loadTable(tableDef) {
      const wrap = document.getElementById('tableWrap');
      const loading = document.getElementById('loading');
      const errEl = document.getElementById('error');
      const countEl = document.getElementById('count');
      wrap.innerHTML = ''; errEl.style.display = 'none'; loading.style.display = 'block';

      try {
        const data = await fetchYaml(tableDef.file);
        let rows = [...(data[tableDef.key] || [])];
        if (tableDef.rowFilter) rows = rows.filter(tableDef.rowFilter);
        const allRows = rows; // for select options

        // Build id -> element map for reference rendering (same YAML file)
        currentRefMap = {};
        Object.keys(data).forEach(k => {
          if (Array.isArray(data[k])) {
            data[k].forEach(item => {
              if (item && item.id) currentRefMap[item.id] = item;
            });
          }
        });

        const columns = getOrderedColumns(tableDef);
        const prefs = getCurrentPrefs(tableDef);

        // global search
        const q = document.getElementById('search').value.toLowerCase().trim();
        if (q) rows = rows.filter(r =>
          columns.some(c => String(r[c.field] ?? '').toLowerCase().includes(q)));

        // per-column filters
        for (const [field, val] of Object.entries(colFilters)) {
          if (!val) continue;
          const v = val.toLowerCase();
          rows = rows.filter(r => String(r[field] ?? '').toLowerCase().includes(v));
        }

        // sort
        if (sortCol) {
          rows.sort((a, b) => {
            const av = sortValue(a[sortCol]), bv = sortValue(b[sortCol]);
            const cmp = av < bv ? -1 : av > bv ? 1 : 0;
            return sortAsc ? cmp : -cmp;
          });
        }

        loading.style.display = 'none';
        countEl.textContent = `${rows.length} item${rows.length !== 1 ? 's' : ''}`;

        const table = document.createElement('table');

        // stable widths per column
        const colgroup = document.createElement('colgroup');
        columns.forEach(c => {
          const col = document.createElement('col');
          if (prefs.widths[c.field]) col.style.width = `${prefs.widths[c.field]}px`;
          colgroup.appendChild(col);
        });
        table.appendChild(colgroup);

        // â”€â”€ thead: header + per-column filters â”€â”€
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        columns.forEach(c => {
          const th = document.createElement('th');
          th.draggable = true;
          th.dataset.field = c.field;

          // reorder (drag/drop)
          th.addEventListener('dragstart', () => th.classList.add('dragging'));
          th.addEventListener('dragend', () => th.classList.remove('dragging'));
          th.addEventListener('dragover', (e) => e.preventDefault());
          th.addEventListener('drop', (e) => {
            e.preventDefault();
            const from = thead.querySelector('th.dragging')?.dataset.field;
            const to = c.field;
            if (!from || from === to) return;
            const order = getOrderedColumns(tableDef).map(x => x.field);
            const fromIx = order.indexOf(from), toIx = order.indexOf(to);
            if (fromIx < 0 || toIx < 0) return;
            order.splice(toIx, 0, order.splice(fromIx, 1)[0]);
            prefs.order = order;
            saveTablePrefs();
            renderAll();
          });

          // sort label
          const label = document.createElement('span');
          label.className = 'header-label';
          label.textContent = c.header;
          if (c.sortable) {
            if (sortCol === c.field) {
              const arrow = document.createElement('span');
              arrow.className = 'sort-arrow';
              arrow.textContent = sortAsc ? ' â–²' : ' â–¼';
              label.appendChild(arrow);
            }
            label.style.cursor = 'pointer';
            label.onclick = () => {
              if (sortCol === c.field) { sortAsc = !sortAsc; }
              else { sortCol = c.field; sortAsc = true; }
              renderAll();
            };
          }
          th.appendChild(label);

          // column filter
          if (c.filterable) {
            const filterDiv = document.createElement('div');
            filterDiv.className = 'col-filter';
            if (c.filterable === 'select') {
              const sel = document.createElement('select');
              const optAll = document.createElement('option');
              optAll.value = ''; optAll.textContent = 'All';
              sel.appendChild(optAll);
              const unique = [...new Set(allRows.map(r => String(r[c.field] ?? '')))].sort();
              unique.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u; opt.textContent = u;
                if (colFilters[c.field] === u) opt.selected = true;
                sel.appendChild(opt);
              });
              sel.onchange = () => { colFilters[c.field] = sel.value; renderAll(); };
              filterDiv.appendChild(sel);
            } else {
              const inp = document.createElement('input');
              inp.type = 'text'; inp.placeholder = 'â€¦';
              inp.value = colFilters[c.field] || '';
              inp.oninput = () => { colFilters[c.field] = inp.value; renderAll(); };
              inp.onclick = (e) => e.stopPropagation();
              filterDiv.appendChild(inp);
            }
            th.appendChild(filterDiv);
          }

          // resize handle
          const handle = document.createElement('div');
          handle.className = 'resize-handle';
          handle.addEventListener('mousedown', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const startX = e.clientX;
            const startW = th.offsetWidth;
            const onMove = (ev) => {
              const w = Math.max(110, startW + (ev.clientX - startX));
              prefs.widths[c.field] = Math.round(w);
              const colIx = columns.findIndex(col => col.field === c.field);
              if (colIx >= 0) colgroup.children[colIx].style.width = `${Math.round(w)}px`;
            };
            const onUp = () => {
              saveTablePrefs();
              document.removeEventListener('mousemove', onMove);
              document.removeEventListener('mouseup', onUp);
              renderAll();
            };
            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onUp);
          });
          th.appendChild(handle);

          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        // â”€â”€ tbody â”€â”€
        const tbody = document.createElement('tbody');
        rows.forEach(row => {
          const tr = document.createElement('tr');
          columns.forEach(c => {
            const td = document.createElement('td');
            if (c.cls) td.classList.add(c.cls);
            const val = row[c.field];
            if (c.render) { td.innerHTML = c.render(val, row); }
            else { td.textContent = val ?? 'â€”'; }
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        wrap.appendChild(table);
      } catch (e) {
        loading.style.display = 'none';
        errEl.style.display = 'block';
        errEl.textContent = `Error: ${e.message}`;
      }
    }

    // â”€â”€ Listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('search').addEventListener('input', () => { yamlCache = {}; renderAll(); });
    document.getElementById('clearAll').addEventListener('click', () => { yamlCache = {}; resetFilters(); renderAll(); });
    document.getElementById('resetLayout').addEventListener('click', () => {
      const tableDef = TABLES.find(t => t.id === currentTable);
      if (tableDef) {
        tablePrefs[tableDef.id] = { order: [], widths: {} };
        saveTablePrefs();
      }
      renderAll();
    });

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    renderAll();
  </script>
</body>
</html>
